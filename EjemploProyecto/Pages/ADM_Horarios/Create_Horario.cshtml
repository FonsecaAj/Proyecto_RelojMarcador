@page
@model EjemploProyecto.Pages.ADM_Horarios.Create_HorarioModel
@{
    ViewData["Title"] = "Crear Horario";
}

<h1>Crear Nuevo Horario</h1>
<hr />

<!-- 🔹 AGREGAR: Mostrar mensajes -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row">
    <div class="col-md-5">
        <form method="post" id="horarioForm">
            <!-- 🔹 Identificación del usuario -->
            <div class="form-group mb-3">
                <label asp-for="Horario.Identificacion" class="control-label">Identificación del Usuario</label>
                <input asp-for="Horario.Identificacion" class="form-control" readonly />
                <span asp-validation-for="Horario.Identificacion" class="text-danger"></span>
            </div>

            <!-- 🔹 Combo de áreas -->
            <div class="form-group mb-3">
                <label class="control-label">Área en la que trabaja</label>
                <select id="selectArea" asp-for="Horario.ID_Area" class="form-select" onchange="actualizarCodigoArea()">
                    <option value="">Seleccione un área</option>
                    @if (Model.AreasDisponibles != null && Model.AreasDisponibles.Any())
                    {
                        foreach (var area in Model.AreasDisponibles)
                        {
                            <option value="@area.ID_Area" data-codigo="@area.Codigo_Area" data-nombre="@area.Nombre_Area">
                                @area.Nombre_Area
                            </option>
                        }
                    }
                </select>
                <span asp-validation-for="Horario.ID_Area" class="text-danger"></span>
            </div>

            <!-- 🔹 Código de área -->
            <div class="form-group mb-3">
                <label asp-for="Horario.Codigo_Area" class="control-label">Código del Área</label>
                <input asp-for="Horario.Codigo_Area" class="form-control" id="codigoArea" readonly />
                <span asp-validation-for="Horario.Codigo_Area" class="text-danger"></span>
            </div>

            <!-- 🔹 AGREGAR ESTO: Campo hidden para Nombre_Area -->
            <input type="hidden" asp-for="Horario.Nombre_Area" id="nombreArea" />

            <!-- 🔹 Botón crear -->
            <div class="form-group mt-4">
                <input type="submit" value="Crear Horario" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div class="mt-3">
    <a asp-page="/ADM_Horarios/Detalle_Horarios" asp-route-id="@Model.Horario.Identificacion">Volver a la lista</a>
</div>

@section Scripts {
    <script>
        function actualizarCodigoArea() {
            const select = document.getElementById("selectArea");
            const selectedOption = select.options[select.selectedIndex];
            const codigo = selectedOption?.getAttribute("data-codigo") || "";
            const nombre = selectedOption?.getAttribute("data-nombre") || "";

            document.getElementById("codigoArea").value = codigo;
            document.getElementById("nombreArea").value = nombre;

            console.log('Área seleccionada:', nombre, 'Código:', codigo);
        }

        // Validar antes de enviar
        document.getElementById('horarioForm').addEventListener('submit', function(e) {
            const idArea = document.querySelector('[name="Horario.ID_Area"]').value;
            const nombreArea = document.getElementById('nombreArea').value;

            console.log('Validando formulario...');
            console.log('ID_Area:', idArea);
            console.log('Nombre_Area:', nombreArea);

            if (!idArea || idArea === '') {
                console.log('❌ ERROR: Debe seleccionar un área');
                alert('Por favor selecciona un área');
                e.preventDefault();
                return;
            }

            if (!nombreArea) {
                console.log('❌ ERROR: Nombre_Area no se cargó correctamente');
                alert('Error al cargar el nombre del área');
                e.preventDefault();
                return;
            }

            console.log('✅ Formulario válido, enviando...');
        });

        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página cargada correctamente');
            // Si hay un área seleccionada por defecto, actualizar los campos
            actualizarCodigoArea();
        });
    </script>
}